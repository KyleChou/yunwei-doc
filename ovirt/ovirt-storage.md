# ovirt存储

oVirt为虚拟机磁盘映像，ISO文件和快照使用集中存储系统。存储网络可以通过以下方式实现

- 网络文件系统（NFS）
- GlusterFS出口
- 其他符合POSIX的文件系统
- 互联网小型计算机系统接口（iSCSI）
- 本地存储直接连接到虚拟主机
- 光纤通道协议（FCP）
- 并行NFS（pNFS）

设置存储是新数据中心的先决条件，因为除非存储域被连接和激活，否则数据中心无法初始化。

作为oVirt系统管理员，您需要为虚拟化企业创建，配置，附加和维护存储。您应该熟悉存储类型及其用法。阅读您的存储阵列供应商指南，了解有关存储的概念，协议，要求或一般用途的更多信息。

oVirt使您能够使用管理门户的存储选项卡分配和管理存储。该存储结果列表显示所有的存储域和详细信息窗格中显示有关域的一般信息。

要添加存储域，您必须能够成功访问管理门户，并且必须至少有一台主机连接状态为Up。

oVirt有三种类型的存储域：

Data Domain：数据域包含数据中心内所有虚拟机和模板的虚拟硬盘和OVF文件。另外，虚拟机的快照也存储在数据域中。

数据域不能在数据中心之间共享。多种类型的数据域（iSCSI，NFS，FC，POSIX和Gluster）可以添加到同一个数据中心，只要它们都是共享的而不是本地域。

您必须先将数据域附加到数据中心，然后才能将其他类型的域附加到数据中心。

ISO域： ISO域存储用于安装和引导虚拟机的操作系统和应用程序的ISO文件（或逻辑CD）。ISO域删除了数据中心对物理介质的需求。ISO域可以在不同的数据中心之间共享。ISO域只能是基于NFS的。只有一个ISO域可以添加到数据中心。

导出域：导出域是临时存储库，用于在数据中心和oVirt环境之间复制和移动图像。导出域可用于备份虚拟机。导出域可以在数据中心之间移动，但是，它一次只能在一个数据中心中活动。导出域只能是基于NFS的。只有一个导出域可以添加到数据中心。

注意：导出存储域已弃用。存储数据域可以从数据中心独立出来，并导入到相同环境或不同环境中的另一个数据中心。然后可以将虚拟机，浮动虚拟磁盘映像和模板从导入的存储域上载到附加的数据中心。有关导入存储域的信息，请参阅导入现有存储域。

重要信息：一旦确定了数据中心的存储需求，就必须开始为oVirt环境配置和附加存储。

了解存储域
存储域是具有公共存储接口的图像集合。存储域包含模板和虚拟机（包括快照）或ISO文件的完整映像。存储域可以由块设备（SAN-iSCSI或FCP）或文件系统（NAS-NFS，GlusterFS或其他符合POSIX的文件系统）组成。

在NFS上，所有虚拟磁盘，模板和快照都是文件。

在SAN（iSCSI / FCP）上，每个虚拟磁盘，模板或快照都是逻辑卷。块设备被聚合成一个称为卷组的逻辑实体，然后被LVM（逻辑卷管理器）分成逻辑卷，以用作虚拟硬盘。

虚拟磁盘可以有两种格式之一，QCOW2或RAW。存储的类型可以是Sparse或Preallocated。快照总是稀疏的，但可以作为RAW或稀疏创建的磁盘使用。

共享相同存储域的虚拟机可以在属于同一集群的主机之间迁移。

准备和添加NFS存储
准备NFS存储
设置将作为Enterprise Linux 6服务器上的数据域和导出域的NFS共享。如果在oVirt Engine安装过程中创建了ISO域，则无需创建ISO域。有关所需系统用户和组的更多信息，请参阅系统帐户。

注意：此过程包括设置不推荐使用的导出存储域的步骤。存储数据域可以从数据中心独立出来，并导入到相同环境或不同环境中的另一个数据中心。然后可以将虚拟机，浮动虚拟磁盘映像和模板从导入的存储域上载到附加的数据中心。有关导入存储域的信息，请参阅导入现有存储域。

安装nfs-utils，提供NFS工具的软件包：

 # yum install nfs-utils
配置引导脚本以在每次系统引导时使共享可用：

 # systemctl daemon-reload
 # systemctl enable rpcbind.service
 # systemctl enable nfs-server.service
启动rpcbind服务和nfs服务：

 # systemctl start rpcbind.service
 # systemctl start nfs-server.service
创建数据目录和导出目录：

 # mkdir -p /exports/data
 # mkdir -p /exports/export
将新创建的目录添加到/etc/exports文件中。将以下内容添加到/etc/exports：

 /exports/data      *(rw)
 /exports/export    *(rw)
导出存储域：

 # exportfs -r
重新加载NFS服务：

 # systemctl reload nfs-server.service
创建组kvm：

 # groupadd kvm -g 36
vdsm在组中创建用户kvm：

 # useradd vdsm -u 36 -g 36
将导出的目录的所有权设置为36:36，这会给vdsm：kvm所有权。这使引擎可以将数据存储在由这些导出目录表示的存储域中：

# chown -R 36:36 /exports/data
# chown -R 36:36 /exports/export
更改目录的模式，以便将读写权限授予给所有者，以便读取和执行访问授予组和其他用户：

# chmod 0755 /exports/data
# chmod 0755 /exports/export
连接NFS存储
将NFS存储域附加到oVirt环境中的数据中心。此存储域为虚拟客户映像和ISO引导介质提供存储。此过程假定您已经输出了份额。您必须在创建导出域之前创建数据域。使用相同的步骤创建导出域，在Domain Function / Storage Type列表中选择Export / NFS。

在oVirt引擎管理门户中，单击存储资源选项卡。

点击新域。

新的域窗口



输入存储域的名称。

接受数据中心，域功能，存储类型，格式和使用主机列表的默认值。

输入用于存储域的导出路径。

导出路径应采用192.168.0.10:/data或的格式domain.example.com:/data。

或者，您可以配置高级参数。

点击高级参数。

在警告低空间指示器字段中输入一个百分比值。如果存储域上的可用空间低于此百分比，则会向用户显示警告消息并进行记录。

在关键空间动作拦截器字段中输入一个GB值。如果存储域上的可用空间低于此值，则会向用户显示错误消息并进行记录，并且即使暂时消耗占用空间的任何新操作也会被阻止。

选择删除后删除复选框以启用删除后删除选项。该选项可以在创建域后进行编辑，但这样做不会在已存在的磁盘的删除属性后更改擦除。

点击确定。

新的NFS数据域将显示在“ 存储”选项卡中，状态为Locked直到磁盘已准备好。数据域然后自动附加到数据中心。

增加NFS存储
要增加NFS存储量，可以创建新的存储域并将其添加到现有的数据中心，或者增加NFS服务器上的可用空间。对于前一个选项，请参阅附加NFS存储。以下过程介绍了如何增加现有NFS服务器上的可用空间。

增加现有的NFS存储域

单击存储资源选项卡并选择一个NFS存储域。

在详细信息窗格中，单击数据中心选项卡并单击维护按钮以将存储域置于维护模式。这会卸载现有的共享并可以调整存储域的大小。

在NFS服务器上，调整存储大小。

在详细信息窗格中，单击“ 数据中心”选项卡，然后单击“ 激活”按钮以装入存储域。

准备和添加本地存储
准备本地存储
本地存储域可以在主机上设置。当您将主机设置为使用本地存储时，主机会自动添加到新的数据中心和群集，而不能添加其他主机。多个主机群集要求所有主机都可以访问所有存储域，这对于本地存储是不可能的。在单个主机群集中创建的虚拟机无法迁移，隔离或调度。有关所需系统用户和组的更多信息，请参阅系统帐户。

重要提示：在oVirt节点上，用于本地存储的路径必须位于/ var目录中; 在以下过程中创建存储目录/var。

准备本地存储

在主机上，创建用于本地存储的目录。

 # mkdir -p /data/images
确保该目录具有允许对vdsm用户（UID 36）和kvm组（GID 36）进行读/写访问的权限。

 # chown 36:36 /data /data/images
 # chmod 0755 /data /data/images
您的本地存储已准备好添加到oVirt环境中。

注意：您也可以将外部存储挂载到主机以用作本地存储域。

添加本地存储
您的主机本地存储已准备就绪。现在使用引擎将其添加到主机。

以这种方式将本地存储添加到主机会导致将主机置于新的数据中心和群集中。本地存储配置窗口将数据中心，集群和存储的创建组合到一个进程中。

添加本地存储

单击主机资源选项卡，然后在结果列表中选择一个主机。

点击维护打开维护主机确认窗口。

单击确定以启动维护模式。

单击配置本地存储以打开配置本地存储窗口。

配置本地存储窗口



单击数据中心，群集和存储字段旁边的编辑按钮以配置本地存储域并为其命名。

在文本输入字段中设置到本地存储的路径。

如果适用，请选择Optimization选项卡为新的本地存储群集配置内存优化策略。

点击确定保存设置并关闭窗口。

您的主机在其自己的数据中心上线。

准备和添加符合POSIX的文件系统存储
通过POSIX文件系统支持，您可以使用与从命令行手动安装相同的安装选项安装文件系统。此功能旨在允许访问未使用NFS，iSCSI或FCP公开的存储。

在oVirt中用作存储域的任何POSIX兼容文件系统都必须支持稀疏文件和直接I / O。例如，通用Internet文件系统（CIFS）不支持直接I / O，因此与oVirt不兼容。

重要提示：不要不通过创建一个POSIX兼容的文件系统存储域挂载NFS存储。改为始终创建一个NFS存储域。

连接符合POSIX的文件系统存储
您希望使用未使用NFS，iSCSI或FCP公开的POSIX兼容文件系统作为存储域。

连接符合POSIX的文件系统存储

单击存储资源选项卡以列出结果列表中的现有存储域。

点击New Domain打开New Domain窗口。

POSIX存储



输入存储域的名称。

选择要与存储域关联的数据中心。所选的数据中心必须是POSIX（符合POSIX标准的FS）类型。或者，选择(none)。

选择Data / POSIX compliant FS从域函数/存储类型下拉菜单。

如果适用，请从下拉菜单中选择格式。

从使用主机下拉菜单中选择一个主机。只有选定数据中心内的主机才会列出。您选择的主机将用于连接存储域。

像通常将其提供给命令一样，输入POSIX文件系统的路径mount。

输入VFS类型，就像通常mount使用-t参数将其提供给命令一样。请参阅有关man mountVFS类型的有效列表。

像通常使用参数将它们提供给命令一样，输入附加的“ 挂载选项”。挂载选项应该以逗号分隔的列表形式提供。请参阅有关有效安装选项的列表。mount-oman mount

或者，您可以配置高级参数。

点击高级参数。

在警告低空间指示器字段中输入一个百分比值。如果存储域上的可用空间低于此百分比，则会向用户显示警告消息并进行记录。

在关键空间动作拦截器字段中输入一个GB值。如果存储域上的可用空间低于此值，则会向用户显示错误消息并进行记录，并且即使暂时消耗占用空间的任何新操作也会被阻止。

选择删除后删除复选框以启用删除后删除选项。该选项可以在创建域后进行编辑，但这样做不会在已存在的磁盘的删除属性后更改擦除。

单击确定以附加新的存储域并关闭窗口。

准备和添加块存储
准备iSCSI存储
使用以下步骤从运行Enterprise Linux 6的服务器中导出iSCSI存储设备，以用作oVirt的存储域。

准备iSCSI存储

在存储服务器上scsi-target-utils使用yumroot命令安装软件包。

 # yum install -y scsi-target-utils
将要导出的设备或文件添加到/etc/tgt/targets.conf文件中。以下是该targets.conf文件基本添加的一般示例：

 <target iqn.YEAR-MONTH.com.EXAMPLE:SERVER.targetX>
           backing-store /PATH/TO/DEVICE1 # Becomes LUN 1
           backing-store /PATH/TO/DEVICE2 # Becomes LUN 2
           backing-store /PATH/TO/DEVICE3 # Becomes LUN 3
 </target>
目标通常使用它们创建的年份和月份，服务器所在的反向完全限定域，服务器名称和目标编号进行定义。

开始tgtd服务。

 # systemctl start tgtd.service
使tgtd开始持续在重新启动。

 # systemctl enable tgtd.service
打开iptables防火墙端口以允许客户端访问您的iSCSI导出。默认情况下，iSCSI使用端口3260.此示例在INPUT表的位置6插入防火墙规则。

 # iptables -I INPUT 6 -p tcp --dport 3260 -j ACCEPT
保存你刚刚创建的iptables规则。

 # service iptables save
您已创建基本的iSCSI导出。您可以将其用作iSCSI数据域。

添加iSCSI存储
oVirt平台通过从由预先存在的LUN组成的卷组中创建存储域来支持iSCSI存储。卷组和LUN都不能同时连接到多个存储域。

添加iSCSI存储

单击存储资源选项卡以列出结果列表中的现有存储域。

点击New Domain按钮打开New Domain窗口。

输入新存储域的名称。

新的iSCSI域



使用数据中心下拉菜单选择一个数据中心。

使用下拉菜单选择域功能和存储类型。与所选域功能不兼容的存储域类型不可用。

在使用主机字段中选择一个活动主机。如果这不是数据中心中的第一个数据域，则必须选择数据中心的SPM主机。

重要提示：所有与存储域的通信都是通过选定的主机，而不是直接来自oVirt Engine。系统中必须至少存在一个活动主机，并将其连接到选定的数据中心。所有主机必须有权访问存储设备，然后才能配置存储域。

oVirt Engine能够将iSCSI目标映射到LUN，或者将LUN映射到iSCSI目标。当选择iSCSI作为存储类型时，“ 新建域”窗口将自动显示具有未使用的LUN的已知目标。如果未添加要添加存储的目标，则可以使用目标发现来查找它，否则请继续下一步。

iSCSI目标发现

点击发现目标以启用目标发现选项。当发现目标并登录后，“ 新建域”窗口将自动显示包含未被环境使用的LUN的目标。

注意：还会显示外部使用的环境LUN。

您可以使用“ 发现目标”选项在多个目标上添加LUN，或者将多个路径添加到相同的LUN。

在地址字段中输入iSCSI主机的完全限定的域名或IP地址。

浏览端口字段中的目标时，输入连接到主机的端口。默认是3260。

如果使用质询握手身份验证协议（CHAP）来保护存储，请选中用户身份验证复选框。输入CHAP用户名和CHAP密码。

注意：现在可以使用REST API为每个主机的每个iSCSI目标定义特定凭证。

点击发现按钮。

从发现结果中选择要使用的目标，然后单击登录按钮。

或者，单击“ 全部登录”以登录到所有发现的目标。

重要提示：如果需要多个路径访问，请确保通过所有必需的路径发现并登录到目标。目前不支持修改存储域以添加其他路径。

点击所需目标旁边的+按钮。这将扩展条目并显示连接到目标的所有未使用的LUN。

选中您用于创建存储域的每个LUN的复选框。

或者，您可以配置高级参数。

点击高级参数。

在警告低空间指示器字段中输入一个百分比值。如果存储域上的可用空间低于此百分比，则会向用户显示警告消息并进行记录。

在关键空间动作拦截器字段中输入一个GB值。如果存储域上的可用空间低于此值，则会向用户显示错误消息并进行记录，并且即使暂时消耗占用空间的任何新操作也会被阻止。

选择删除后删除复选框以启用删除后删除选项。该选项可以在创建域后进行编辑，但这样做不会在已存在的磁盘的删除属性后更改擦除。

单击确定以创建存储域并关闭窗口。

如果您为同一个目标配置了多个存储连接路径，请按照下一节“配置iSCSI多路径”中的步骤完成iSCSI绑定。

配置iSCSI多路径
在iSCSI多路径，您可以创建和管理逻辑网络和iSCSI存储连接的群体。为防止由于网络路径故障导致主机停机，请在主机和iSCSI存储器之间配置多个网络路径。配置完成后，引擎会通过与同一iSCSI绑定的逻辑网络相关的NIC / VLAN将数据中心中的每台主机连接到每个绑定目标。您还可以指定要将哪些网络用于存储通信，而不是允许主机通过默认网络路由通信。此选项仅在管理门户中至少有一个iSCSI存储域已连接到数据中心后可用。

先决条件

确保您已创建iSCSI存储域，并发现并登录到iSCSI目标的所有路径。

确保您创建了非必需的逻辑网络以与iSCSI存储连接进行绑定。您可以配置多个逻辑网络或绑定网络以允许网络故障切换。

配置iSCSI多路径

单击数据中心选项卡并从结果列表中选择一个数据中心。

在详细信息窗格中，单击iSCSI多路径选项卡。

点击添加。

在添加iSCSI绑定窗口中，输入债券的名称和说明。

从逻辑网络列表中选择要用于绑定的网络。网络必须是非必需网络。

注意：要更改网络的必需名称，请从管理门户中选择一个网络，单击群集选项卡，然后单击管理网络按钮。

从存储目标列表中选择要通过所选网络访问的存储域。确保选择到同一个目标的所有路径。

点击确定。

数据中心中的所有主机都通过选定的逻辑网络连接到选定的iSCSI目标。

添加FCP存储
oVirt平台通过从由预先存在的LUN组成的卷组中创建存储域来支持SAN存储。卷组和LUN都不能同时连接到多个存储域。

oVirt系统管理员需要具备存储区域网络（SAN）概念的工作知识。SAN通常使用光纤通道协议（FCP）用于主机和共享外部存储器之间的流量。出于这个原因，SAN有时可能被称为FCP存储。

以下过程说明如何将现有的FCP存储作为数据域附加到oVirt环境。有关其他支持的存储类型的更多信息，请参阅存储。

添加FCP存储

单击存储资源选项卡以列出所有存储域。

点击New Domain打开New Domain窗口。

输入存储域的名称。

添加FCP存储



使用数据中心下拉菜单选择一个FCP数据中心。

如果您还没有合适的FCP数据中心，请选择(none)。

使用下拉菜单选择域功能和存储类型。与所选数据中心不兼容的存储域类型不可用。

在使用主机字段中选择一个活动主机。如果这不是数据中心中的第一个数据域，则必须选择数据中心的SPM主机。

重要提示：所有与存储域的通信都是通过选定的主机，而不是直接来自oVirt Engine。系统中必须至少存在一个活动主机，并将其连接到选定的数据中心。所有主机必须有权访问存储设备，然后才能配置存储域。

当选择数据/光纤通道作为存储类型时，新域窗口会自动显示具有未使用的LUN的已知目标。选中LUN ID复选框以选择所有可用的LUN。

或者，您可以配置高级参数。

点击高级参数。

在警告低空间指示器字段中输入一个百分比值。如果存储域上的可用空间低于此百分比，则会向用户显示警告消息并进行记录。

在关键空间动作拦截器字段中输入一个GB值。如果存储域上的可用空间低于此值，则会向用户显示错误消息并进行记录，并且即使暂时消耗占用空间的任何新操作也会被阻止。

选择删除后删除复选框以启用删除后删除选项。该选项可以在创建域后进行编辑，但这样做不会在已存在的磁盘的删除属性后更改擦除。

单击确定以创建存储域并关闭窗口。

新的FCP数据域显示在“ 存储”选项卡上。它Locked在准备使用时将保持状态。准备好后，它会自动连接到数据中心。

增加iSCSI或FCP存储
有多种方法可以增加iSCSI或FCP存储容量：

使用新LUN创建新存储域并将其添加到现有数据中心。请参阅添加iSCSI存储。

创建新的LUN并将它们添加到现有存储域。

通过调整底层LUN的大小来扩展存储域。

以下过程介绍了如何通过将新LUN添加到现有存储域来扩展存储区域网络（SAN）存储。

增加现有的iSCSI或FCP存储域

在SAN上创建一个新的LUN。

单击存储资源选项卡并选择一个iSCSI或FCP域。

点击编辑按钮。

点击目标> LUN，然后点击发现目标扩展按钮。

输入存储服务器的连接信息，然后单击Discover按钮启动连接。

点击LUNs> Targets，然后选中新可用LUN的复选框。

单击确定将LUN添加到选定的存储域。

这将按照添加的LUN的大小增加存储域。

通过调整基础LUN的大小来扩展存储域时，LUN也必须在oVirt管理门户中进行刷新。

刷新LUN大小

单击存储资源选项卡并选择一个iSCSI或FCP域。

点击编辑按钮。

点击LUN>目标。

在“ 其他大小”列中，单击LUN 的“ 添加Additional_Storage_Size”按钮以刷新。

单击确定以刷新LUN以指示新的存储大小。

oVirt中不可用的LUN
在某些情况下，oVirt Engine将不允许您使用LUN来创建存储域或虚拟机硬盘。

已经成为当前oVirt环境的一部分的LUN将被自动阻止使用。

oVirt管理门户中不可用的LUN



已被SPM主机使用的LUN也将显示为正在使用中。您可以选择强制使用这些LUN的内容，但操作无法保证成功。

导入现有的存储域
导入现有存储域的概述
除了添加不包含数据的新存储域之外，还可以导入现有的存储域并访问它们包含的数据。通过导入存储域，您可以在发动机数据库发生故障时恢复数据，并将数据从一个数据中心或环境迁移到另一个数据中心或环境。

以下是导入每个存储域类型的概述：

数据
导入现有数据存储域允许您访问数据存储域包含的所有虚拟机和模板。导入存储域后，必须手动将虚拟机，浮动磁盘映像和模板导入目标数据中心。导入数据存储域包含的虚拟机和模板的过程与导出存储域的过程类似。但是，由于数据存储域包含给定数据中心中的所有虚拟机和模板，建议将数据存储域导入数据中心或环境之间进行数据恢复或虚拟机的大规模迁移。
重要说明：您可以导入已连接到兼容级别为3.5或更高的数据中心的现有数据存储域。

ISO
导入现有的ISO存储域允许您访问ISO存储域包含的所有ISO文件和虚拟软盘。导入存储域以访问这些资源后，不需要执行其他操作; 您可以根据需要将它们附加到虚拟机。
出口
导入现有的导出存储域允许您访问导出存储域包含的所有虚拟机映像和模板。由于导出域旨在用于导出和导入虚拟机映像和模板，因此导入导出存储域是在环境内或环境之间迁移少量虚拟机和模板的推荐方法。有关将虚拟机和模板导出到导出存储域以及从导出存储域导入虚拟机和模板的信息，请参阅“ 虚拟机管理指南 ”中的“导出和导入虚拟机和模板” 。
注意：导出存储域已弃用。存储数据域可以从数据中心独立出来，并导入到相同环境或不同环境中的另一个数据中心。然后可以将虚拟机，浮动虚拟磁盘映像和模板从导入的存储域上载到附加的数据中心。

导入存储域
导入以前连接到相同环境或不同环境中的数据中心的存储域。此过程假定存储域不再连接到任何环境中的任何数据中心，以避免数据损坏。要将现有数据存储域导入并附加到数据中心，必须初始化目标数据中心。

导入存储域

单击存储资源选项卡。

点击导入域。

导入预配置的域窗口



从数据中心下拉列表中选择要将存储域附加到的数据中心。

输入存储域的名称。

从相应的下拉列表中选择域功能和存储类型。

从使用主机下拉列表中选择一个主机。

重要提示：所有与存储域的通信都是通过选定的主机，而不是直接来自oVirt Engine。系统中必须至少存在一个活动主机，并将其连接到选定的数据中心。所有主机必须有权访问存储设备，然后才能配置存储域。

输入存储域的详细信息。

注意：用于指定存储域详细信息的字段将根据您在“ 域功能/存储类型”列表中选择的值进行更改。这些选项与可用于添加新存储域的选项相同。有关这些选项的更多信息，请参阅存储属性。

选中“ 在数据中心激活域”复选框以在将存储域附加到所选数据中心后激活存储域。

点击确定。

存储域已导入，并显示在“ 存储”选项卡中。您现在可以将虚拟机和模板从存储域导入数据中心。

在同一环境中的数据中心之间迁移存储域
在同一个oVirt环境中将存储域从一个数据中心迁移到另一个数据中心，以允许目标数据中心访问存储域中包含的数据。此过程涉及将存储域从一个数据中心中分离出来，并将其附加到不同的数据中心。

在同一环境中的数据中心之间迁移存储域

关闭在所需存储域上运行的所有虚拟机。

单击存储资源选项卡并从结果列表中选择存储域。

单击详细信息窗格中的数据中心选项卡。

单击维护，然后单击确定将存储域移到维护模式。

单击分离，然后单击确定以从源数据中心分离存储域。

点击附加。

选择目标数据中心，然后单击确定。

存储域连接到目标数据中心并自动激活。您现在可以将虚拟机和模板从存储域导入目标数据中心。

在不同环境中迁移数据中心之间的存储域
将存储域从一个oVirt环境迁移到另一个环境，以允许目标环境访问存储域中包含的数据。此过程涉及从一个oVirt环境中删除存储域，并将其导入到不同的环境中。要将现有数据存储域导入并附加到oVirt数据中心，存储域的源数据中心必须具有3.5或更高的兼容性级别。

在不同环境中迁移数据中心之间的存储域

登录到源环境的管理门户。

关闭在所需存储域上运行的所有虚拟机。

单击存储资源选项卡并从结果列表中选择存储域。

单击详细信息窗格中的数据中心选项卡。

单击维护，然后单击确定将存储域移到维护模式。

单击分离，然后单击确定以从源数据中心分离存储域。

点击删除。

在删除存储窗口中，确保格式域，即存储内容将丢失！复选框未被选中。此步骤保留存储域中的数据供以后使用。

单击确定从源环境中删除存储域。

登录到目标环境的管理门户。

单击存储资源选项卡。

点击导入域。

导入预配置的域窗口



从数据中心下拉列表中选择目标数据中心。

输入存储域的名称。

从相应的下拉列表中选择域功能和存储类型。

从Use Host下拉列表中选择一个主机。

输入存储域的详细信息。

注意：用于指定存储域详细信息的字段将根据您在“ 存储类型”下拉列表中选择的值进行更改。这些选项与可用于添加新存储域的选项相同。有关这些选项的更多信息，请参阅存储属性。

选中“ 在数据中心激活域”复选框，以便在连接时自动激活存储域。

点击确定。

存储域在新的oVirt环境中附加到目标数据中心，并自动激活。您现在可以将虚拟机和模板从导入的存储域导入到目标数据中心。

从导入的数据存储域导入虚拟机
从已导入到oVirt环境中的数据存储域导入虚拟机。此过程假定导入的数据存储域已连接到数据中心并已激活。

从导入的数据存储域导入虚拟机

单击存储资源选项卡。

点击导入的数据存储域。

在详细信息窗格中单击虚拟机导入选项卡。

选择一个或多个要导入的虚拟机。

点击导入。

从群集列表中选择要将虚拟机导入到的群集。

点击确定。

您已将一个或多个虚拟机导入到您的环境中。导入的虚拟机不再显示在VM Import选项卡下的列表中。

从导入的存储域导入磁盘映像
使用详细信息窗格的“ 磁盘导入”选项卡从导入的存储域导入浮动虚拟磁盘。

注意：只有兼容QEMU的磁盘可以导入引擎。

导入磁盘映像

选择已导入数据中心的存储域。

在详细信息窗格中，单击磁盘导入。

选择一个或多个磁盘映像，然后单击“ 导入”以打开“ 导入磁盘”窗口。

为每个磁盘选择适当的磁盘配置文件。

单击确定导入选定的磁盘。

从导入的存储域导入未注册的磁盘映像
使用详细信息窗格的“ 磁盘导入”选项卡从存储域导入浮动虚拟磁盘。在oVirt环境之外创建的浮动磁盘未在引擎中注册。扫描存储域以识别要导入的未注册浮动盘。

注意：只有兼容QEMU的磁盘可以导入引擎。

导入磁盘映像

选择已导入数据中心的存储域。

右键单击存储域并选择扫描磁盘，以便引擎可以识别未注册的磁盘。

在详细信息窗格中，单击磁盘导入。

选择一个或多个磁盘映像，然后单击“ 导入”以打开“ 导入磁盘”窗口。

为每个磁盘选择适当的磁盘配置文件。

单击确定导入选定的磁盘。

存储任务
填充ISO存储域
ISO存储域连接到数据中心。ISO映像必须上传到它。oVirt提供ISO上传工具，可确保图像以正确的用户权限上传到正确的目录路径。

本文档未描述从物理介质创建ISO映像。假定您可以访问您的环境所需的图像。

填充ISO存储域

将所需的ISO映像复制到运行oVirt Engine的系统上的临时目录。

以root用户身份登录到运行oVirt Engine的系统。

使用该engine-iso-uploader命令上传ISO映像。此操作需要一些时间。时间长短取决于正在上传的映像的大小和可用的网络带宽。

ISO上传器使用情况

在这个例子中，ISO映像RHEL6.iso被上传到ISODomain使用NFS 调用的ISO域。该命令将提示输入管理用户名和密码。用户名必须在表单中提供user name@domain。

 # engine-iso-uploader --iso-domain=ISODomain upload RHEL6.iso
ISO映像已上载并显示在指定的ISO存储域中。在存储域所连接的数据中心中创建虚拟机时，它也可用于可用引导介质列表中。

将存储域移动到维护模式
分离和删除存储域需要它们处于维护模式。这是重新指定另一个数据域作为主数据域所必需的。

通过添加更多LUN来扩展iSCSI域只能在域激活时完成。

将存储域移到维护模式

关闭存储域上运行的所有虚拟机。

单击存储资源选项卡并选择一个存储域。

单击详细信息窗格中的数据中心选项卡。

点击维护打开存储域维护确认窗口。

单击确定以启动维护模式。存储域已取消激活，并Inactive在结果列表中具有状态。

您现在可以编辑，分离，移除或重新激活数据中心的非活动存储域。

注意：您还可以使用与其相关联的数据中心的详细信息窗格上的存储选项卡激活，分离域并将其置于维护模式。

编辑存储域
您可以通过管理门户编辑存储域参数。根据存储域的状态（活动或不活动），可以使用不同的字段进行编辑。数据中心，域功能，存储类型和格式等字段不能更改。

活动：当存储域处于活动状态时，可以编辑名称，说明，注释，警告低空间指示符（％），关键空间操作阻止程序（GB）和擦除后删除字段。的名称而存储域处于活动状态字段只能进行编辑。所有其他字段也可以在存储域处于非活动状态时进行编辑。

非活动：当存储域处于维护模式或未连接时，因此处于非活动状态，您可以编辑除名称，数据中心，域功能，存储类型和格式之外的所有字段。存储域必须处于非活动状态才能编辑存储连接，装入选项和其他高级参数。这仅适用于NFS，POSIX和本地存储类型。

注意： iSCSI存储连接无法通过管理门户进行编辑，但可以通过REST API进行编辑。

编辑主动存储域

单击存储选项卡并选择一个存储域。

点击修改。

根据需要编辑可用字段。

点击确定。

编辑非活动存储域

单击存储选项卡并选择一个存储域。

如果存储域处于活动状态，请单击详细信息窗格中的数据中心选项卡，然后单击维护。

点击修改。

根据需要编辑存储路径和其他详细信息。新的连接细节必须与原始连接具有相同的存储类型。

点击确定。

单击详细信息窗格中的数据中心选项卡，然后单击激活。

从维护模式激活存储域
如果您对数据中心的存储进行了更改，则必须将存储域置于维护模式。激活存储域以继续使用它。

单击存储资源选项卡并在结果列表中选择一个不活动的存储域。

单击详细信息窗格中的数据中心选项卡。

选择适当的存储域并点击激活。

重要提示：如果您在激活数据域之前尝试激活ISO域，则会显示错误消息并且域未激活。

删除存储域
您希望从虚拟环境中删除数据中心中的存储域。

删除存储域

单击存储资源选项卡并在结果列表中选择适当的存储域。

将域移入维护模式以停用它。

从数据中心分离域。

单击删除打开删除存储确认窗口。

从列表中选择一个主机。

点击确定删除存储域并关闭窗口。

存储域被永久地从环境中移除。

销毁存储域
遇到错误的存储域可能无法通过正常程序删除。销毁存储域将强制从虚拟环境中删除存储域，而不参考导出目录。

当存储域被破坏时，您需要手动修复存储域的导出目录，然后才能再次使用它。

销毁存储域

使用存储资源选项卡，树状模式或搜索功能在结果列表中查找并选择适当的存储域。

右键单击存储域并选择销毁以打开销毁存储域确认窗口。

选中批准操作复选框，然后单击确定以销毁存储域并关闭窗口。

存储域已被破坏。手动清理存储域的导出目录以回收它。

从数据中心分离存储域
从数据中心分离存储域以将虚拟机和模板迁移到另一个数据中心。

从数据中心分离存储域

单击存储资源选项卡，然后从结果列表中选择一个存储域。

单击详细信息窗格中的数据中心选项卡，然后选择存储域。

点击维护打开维护存储域确认窗口。

单击确定以启动维护模式。

单击分离以打开分离存储确认窗口。

单击确定以分离存储域。

存储域已从数据中心分离出来，随时可以连接到另一个数据中心。

将存储域附加到数据中心
将存储域连接到数据中心。

将存储域附加到数据中心

单击存储资源选项卡，然后从结果列表中选择一个存储域。

单击详细信息窗格中的数据中心选项卡。

单击附加打开附加到数据中心窗口。

选择适当数据中心的单选按钮。

单击确定以附加存储域。

存储域连接到数据中心并自动激活。

磁盘配置文件
磁盘配置文件定义了存储域中虚拟磁盘的最大吞吐量级别和最大输入和输出操作级别。磁盘配置文件是基于数据中心下定义的存储配置文件创建的，必须手动分配到单个虚拟磁盘才能使配置文件生效。

创建磁盘配置文件
创建一个磁盘配置。此过程假定您已经在存储域所属的数据中心下定义了一个或多个存储服务质量条目。

创建磁盘配置文件

单击存储资源选项卡并选择一个数据存储域。

单击详细信息窗格中的磁盘配置文件子选项卡。

点击新建。

在名称字段中输入磁盘配置文件的名称。

在说明字段中输入磁盘配置文件的说明。

从QoS列表中选择应用于磁盘配置文件的服务质量。

点击确定。

您已创建磁盘配置文件，并且该磁盘配置文件可应用于数据存储域中托管的新虚拟磁盘。

删除磁盘配置文件
从oVirt环境中移除现有的磁盘配置文件。

删除磁盘配置文件

单击存储资源选项卡并选择一个数据存储域。

单击详细信息窗格中的磁盘配置文件子选项卡。

选择要删除的磁盘配置文件。

点击删除。

点击确定。

您已删除磁盘配置文件，并且该磁盘配置文件不再可用。如果将磁盘配置文件分配给任何虚拟磁盘，则会从这些虚拟磁盘中删除该磁盘配置文件。

查看存储域的健康状况
除了常规状态之外，存储域还具有外部健康状态。外部运行状况由插件或外部系统报告，或由管理员设置，并显示在存储域的名称左侧作为以下图标之一：

好的：没有图标

信息：

警告：

错误：

失败：

要查看有关存储域健康状态的更多详细信息，请选择存储域，然后单击事件子选项卡。

存储域的健康状况也可以使用REST API查看。甲GET上的存储域请求将包括external_status元件，它包含的健康状态。

您可以通过events集合在REST API中设置存储域的健康状态。

存储和权限
管理存储域的系统权限
作为超级用户，系统管理员管理管理门户的各个方面。更具体的管理角色可以分配给其他用户。这些受限制的管理员角色对于授予用户将其限制为特定资源的管理权限很有用。例如，DataCenterAdmin角色仅对已分配的数据中心拥有管理员权限（数据中心的存储除外），并且ClusterAdmin仅对已分配的群集拥有管理员权限。

存储管理员仅是特定存储域的系统管理角色。这在具有多个存储域的数据中心很有用，其中每个存储域需要系统管理员。使用标题栏中的“ 配置”按钮为环境中的所有存储域分配存储管理员。

存储域管理员角色允许执行以下操作：

编辑存储域的配置。

将存储域移到维护模式。

删除存储域。

注意：您只能将角色和权限分配给现有用户。

您还可以通过删除现有的系统管理员并添加新的系统管理员来更改存储域的系统管理员。

存储管理员角色解释
存储域权限角色

下表描述了适用于存储域管理的管理员角色和权限。

oVirt系统管理员角色

角色	特权	笔记
StorageAdmin	存储管理员	可以创建，删除，配置和管理特定的存储域。
GlusterAdmin	Gluster存储管理员	可以创建，删除，配置和管理Gluster存储卷。
将管理员或用户角色分配给资源
将管理员或用户角色分配给资源以允许用户访问或管理该资源。

为资源分配一个角色

使用资源选项卡，树形模式或搜索功能来查找并选择结果列表中的资源。

单击详细信息窗格中的权限选项卡，以列出分配的用户，用户的角色以及所选资源的继承权限。

点击添加。

输入名称或现有的用户进入的用户名搜索文本框，然后点击进入。从可能的匹配结果列表中选择一个用户。

从Role to Assign：下拉列表中选择一个角色。

点击确定。

您已将角色分配给用户; 用户现在拥有为该资源启用的该角色的继承权限。

从资源中删除管理员或用户角色
从资源中删除管理员或用户角色; 用户失去与该资源的角色相关联的继承权限。

从资源中删除角色

使用资源选项卡，树形模式或搜索功能来查找并选择结果列表中的资源。

单击详细信息窗格中的权限选项卡，以列出分配的用户，用户的角色以及所选资源的继承权限。

选择要从资源中删除的用户。

点击删除。“ 删除权限”窗口打开以确认删除权限。

点击确定。

您已从资源中删除用户的角色和关联的权限。
